<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Street View</title>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #street-view { height: 100%; }
    </style>
</head>
<body>
<div id="street-view"></div>
<script>
    var panorama;
    var directionsDisplay;
    var isClick = false;
    var pathArray = new Array();
    var directionsService;
    var isGetPath = false;
    var marker2;

    function initialize() {
        var test = document.getElementById('test');
        var test2 = document.getElementById('test2');
        map = new google.maps.Map(document.getElementById('street-view'),
            {
                center: { lat: 22.277782, lng: 114.170241 },
                zoom: 2,
            });
        directionsDisplay = new google.maps.DirectionsRenderer();
        directionsDisplay.setMap(map);
        directionsService = new google.maps.DirectionsService();
        panorama = map.getStreetView();
        //panorama.setPosition({ lat: 22.277782, lng: 114.170241 });
        panorama.setVisible(false);
        panorama.setOptions({ linksControl: false, });
    }

    function insertMark(markLat, markLng, num) {
        var imgPath;
        if (num === 0) {
            imgPath = 'http://123.206.78.137:8080/Download/Source/IMG_20160902_124718.jpg';
        } else {
            imgPath = 'http://123.206.78.137:8080/Download/Source/IMG_20160902_125939.jpg';
        }
        var image = {
            url: 'http://123.206.78.137:8080/Download/Source/touch.png',
            // This marker is 20 pixels wide by 32 pixels high.
            size: new google.maps.Size(300, 300),
            // The origin for this image is (0, 0).
            origin: new google.maps.Point(0, 0), //全景位置
            // The anchor for this image is the base of the flagpole at (0, 32).
            anchor: new google.maps.Point(100, 400), //高度
            scaledSize: new google.maps.Size(300, 300),
            //labelOrigin: new google.maps.Point(100, 100)
        };
        marker2 = new google.maps.Marker({
            position: { lat: markLat, lng: markLng },
            map: panorama,
            icon: image,
            opacity: 0.8,
            label: { text: '触动此处回忆',fontSize: '20px' },
        });
        marker2.addListener('click',
            function() {
                isClick = true;
                marker2.setVisible(false);
            });
        setMarkHeading();
    }

    function getClick() {
        if (isClick)
            return 'click';
        else return 'not click';
    }

    function getPath(startLat, startLng, endLat, endLng) {
        directionsService.route({
                origin: { lat: startLat, lng: startLng },
                destination: { lat: endLat, lng: endLng },
                provideRouteAlternatives: false,
                travelMode: 'WALKING',
                unitSystem: google.maps.UnitSystem.IMPERIAL
            },
            function(result, status) {
                if (status == 'OK') {
                    directionsDisplay.setDirections(result); //地图中显示
                    var short = 0;
                    var x = result.routes[0].overview_path.length;
                    for (var i in result.routes) {
                        var tmp = result.routes[i].overview_path.length;
                        if (tmp < x) {
                            x = tmp;
                            short = i;
                        }
                    }
                    pathArray = result.routes[short].overview_path;
                    isGetPath = true;
                } else {
                    console.log('No Route');
                }
            });
    }

    function getPathPoint() {
        var cot;
        var pathPoint = '';
        for (cot in pathArray)
            pathPoint += pathArray[cot].lat() + ',' + pathArray[cot].lng() + '\n';
        return pathPoint;
    }

    function testIsGetPath() {
        if (isGetPath) return 'Y';
        else return 'N';
    }

    function setIsGetPath() {
        isGetPath = false;
    }

    function setMarkHeading() {
        var heading2 = google.maps.geometry.spherical.computeHeading(panorama.location.latLng, marker2.getPosition());
        //panorama.setPov({ heading: heading2, pitch: 0 });
        var difference = heading2 - panorama.getPov().heading;
        if (Math.abs(difference) > 180) {
            if (difference > 0) {
                difference = -(360 - difference);
            } else {
                difference = 360 + difference;
            }
        }
        difference = difference / 5;
        cot = 0;
        changeHeadingAnimation(difference);
    }

    function changeHeadingAnimation(heading) {
        panorama.setPov({ heading: panorama.getPov().heading + heading, pitch: 0 });
        if (cot < 4) {
            cot++;
            var t = setTimeout("changeHeadingAnimation(" + heading + ")", 200);
        }
    }
</script>
<script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB2XzGNuHQLEd1AGjAnYkC6EoREiS_K09Q&callback=initialize">
</script>
</body>
</html>